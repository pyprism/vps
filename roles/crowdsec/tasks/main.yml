---
# CrowdSec role - Install CrowdSec security suite

- name: Install CrowdSec prerequisites
  ansible.builtin.apt:
    name:
      - curl
      - gnupg
    state: present

- name: Add CrowdSec GPG key
  ansible.builtin.get_url:
    url: https://packagecloud.io/crowdsec/crowdsec/gpgkey
    dest: /etc/apt/keyrings/crowdsec.asc
    mode: '0644'

- name: Add CrowdSec repository
  ansible.builtin.apt_repository:
    repo: "deb [signed-by=/etc/apt/keyrings/crowdsec.asc] https://packagecloud.io/crowdsec/crowdsec/{{ ansible_facts['distribution'] | lower }}/ {{ ansible_facts['distribution_release'] }} main"
    state: present
    filename: crowdsec
    update_cache: false

- name: Update apt cache for CrowdSec
  ansible.builtin.raw: apt-get update -o APT::Update::Post-Invoke-Success="" -qq
  changed_when: false

- name: Install CrowdSec
  ansible.builtin.apt:
    name:
      - crowdsec
      - crowdsec-firewall-bouncer-iptables
    state: present
    update_cache: false

- name: Ensure CrowdSec is enabled and running
  ansible.builtin.systemd:
    name: crowdsec
    state: started
    enabled: true

- name: Check installed CrowdSec collections
  ansible.builtin.command:
    cmd: cscli collections list -o raw
  register: crowdsec_installed_collections
  changed_when: false
  failed_when: false

- name: Install CrowdSec collections
  ansible.builtin.command:
    cmd: "cscli collections install {{ item }}"
  loop: "{{ crowdsec_collections }}"
  when: item not in crowdsec_installed_collections.stdout
  register: crowdsec_install
  changed_when: crowdsec_install.rc == 0
  failed_when: false

